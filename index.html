<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Diver Reverse</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Font dự phòng cho văn bản UI */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(to bottom, #2C5E7D, #4A90E2); /* Chuyển màu nước */
            color: #333;
        }

        .game-container {
            position: relative;
            background-color: #4A90E2; /* Màu nền nước cho khu vực game */
            border-radius: 1.5rem;
            overflow: hidden;
            border: 8px solid #cbd5e0;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            width: 90vw; /* Chiều rộng thích ứng */
            max-width: 400px; /* Chiều rộng tối đa */
            height: 90vh; /* Chiều cao thích ứng */
            max-height: 600px; /* Chiều cao tối đa */
        }

        canvas {
            background-color: #4A90E2; /* Màu nền nước cho canvas */
            display: block;
            border-radius: 10px;
            flex-grow: 1; /* Cho phép canvas chiếm không gian */
            width: 100%;
            height: auto; /* Duy trì tỷ lệ khung hình */
            border: 2px solid #5a5a5a;
            display: none; /* Ẩn canvas mặc định cho đến khi game bắt đầu */
        }

        .ui-panel {
            width: 100%;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            color: #333;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            margin-top: 10px;
        }

        /* Màn hình khởi đầu chung và màn hình game over */
        .initial-screen, .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            text-align: center;
            z-index: 100;
            border-radius: 1.5rem;
            padding: 20px;
            box-sizing: border-box;
        }

        .initial-screen h1, .game-over-screen h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #FFD700; /* Màu vàng kim cho tiêu đề */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            font-family: 'Press Start 2P', cursive;
        }

        .initial-screen p, .game-over-screen p {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-group label {
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .input-group input[type="text"],
        .input-group input[type="password"] {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1rem;
            width: 200px;
            max-width: 80%;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .gender-selection button {
            padding: 10px 20px;
            margin: 0 10px;
            background-color: #6366f1; /* Màu xanh tím */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .gender-selection button.selected {
            background-color: #4f46e5; /* Màu xanh tím đậm hơn khi chọn */
            border: 2px solid #FFD700;
            transform: translateY(-2px);
        }

        .gender-selection button:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }

        .start-button, .restart-button, .submit-button, .quiz-button {
            padding: 15px 30px;
            background-color: #4CAF50; /* Nút màu xanh lá */
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            margin-top: 20px;
            font-family: 'Inter', sans-serif;
        }

        .start-button:hover, .restart-button:hover, .submit-button:hover, .quiz-button:hover {
            background-color: #45a049;
            transform: translateY(-3px);
        }

        .start-button:active, .restart-button:active, .submit-button:active, .quiz-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .hidden {
            display: none !important; /* Dùng !important để đảm bảo ẩn */
        }

        /* Styles for iOS-style lock screen */
        #lockScreen {
            background-color: #000;
            color: white;
            font-family: 'Inter', sans-serif;
            font-weight: 300;
            font-size: 1.8rem;
            letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #lockScreen h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: white;
            text-shadow: none;
            font-family: 'Inter', sans-serif;
            font-weight: 200;
        }
        #passcodeDots {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .dot {
            width: 15px;
            height: 15px;
            border: 2px solid white;
            border-radius: 50%;
            background-color: transparent;
            transition: background-color 0.2s ease;
        }
        .dot.filled {
            background-color: white;
        }
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 280px;
            max-width: 80%;
        }
        .keypad button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.8rem;
            font-weight: 300;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .keypad button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .keypad button:active {
            transform: scale(0.95);
        }
        .keypad .empty-cell {
            background: transparent;
            border: none;
            box-shadow: none;
            cursor: default;
        }
        #lockMessage {
            color: #EF4444;
            font-size: 1rem;
            margin-top: 10px;
            text-shadow: none;
        }

        /* Quiz screen */
        #quizScreen {
            background-color: rgba(0, 0, 100, 0.8); /* Darker blue overlay for quiz */
        }
        #quizScreen .question {
            font-size: 1.2rem;
            margin-bottom: 20px;
            max-width: 90%;
        }
        #quizScreen .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 90%;
            max-width: 300px;
        }
        #quizScreen .options button {
            background-color: #6366f1;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #quizScreen .options button:hover {
            background-color: #4f46e5;
        }
        #quizResult {
            margin-top: 20px;
            font-size: 1rem;
            color: #FFD700;
        }

        /* Essay screen */
        #essayScreen textarea {
            width: 90%;
            max-width: 300px;
            height: 100px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            resize: vertical;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        #wordCount {
            font-size: 0.9rem;
            margin-top: 5px;
            color: #bbb;
        }
        #essayMessage {
            color: #EF4444;
            font-size: 1rem;
            margin-top: 5px;
            text-shadow: none;
        }

        /* Ready to Play Screen */
        #readyToPlayScreen {
            background-color: rgba(0, 128, 0, 0.8); /* Greenish overlay */
        }
        #readyToPlayScreen h2 {
            color: #A7D3EE; /* Light blue for confirmation */
        }
        #readyToPlayScreen p {
            font-size: 1.2rem;
            margin-top: 15px;
        }
        #readyToPlayScreen .confirmation-details {
            font-size: 1.1rem;
            margin-top: 10px;
        }

        /* Transition effect */
        .door-transition {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 200; /* Above all screens */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            opacity: 0;
            pointer-events: none; /* Allows clicks to pass through when not active */
            transition: opacity 0.5s ease-out;
        }
        .door-transition.active {
            opacity: 1;
            pointer-events: auto;
        }
        .door-transition .door-left,
        .door-transition .door-right {
            position: absolute;
            width: 50%;
            height: 100%;
            background-color: #4a4a4a; /* Màu cửa */
            transition: transform 1s ease-in-out;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .door-transition .door-left {
            left: 0;
            transform: translateX(0%);
            transform-origin: left center;
        }
        .door-transition .door-right {
            right: 0;
            transform: translateX(0%);
            transform-origin: right center;
        }
        .door-transition.open .door-left {
            transform: translateX(-100%);
        }
        .door-transition.open .door-right {
            transform: translateX(100%);
        }
        .door-transition .center-light {
            position: absolute;
            width: 0px;
            height: 0px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,100,0.8) 0%, transparent 70%);
            opacity: 0;
            transition: width 1s ease-in-out, height 1s ease-in-out, opacity 0.5s ease-in-out 0.5s; /* Light appears after doors start opening */
        }
        .door-transition.open .center-light {
            width: 600px;
            height: 600px;
            opacity: 1;
        }

        /* Message Box styles */
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(44, 94, 125, 0.95); /* Darker blue, semi-transparent */
            color: white;
            padding: 25px 35px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
            z-index: 201; /* Above door transition */
            text-align: center;
            max-width: 80%;
            font-size: 1.1rem;
            border: 2px solid #a7d3ee;
        }
        .message-box p {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .message-box button {
            background-color: #FFD700; /* Gold color */
            color: #333;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: bold;
        }
        .message-box button:hover {
            background-color: #e6c200;
            transform: translateY(-2px);
        }

        /* Styles for Gift Box and Letter */
        #giftBoxScreen, #letterScreen {
            background-color: rgba(0, 100, 0, 0.9); /* Dark green for gifts */
            z-index: 101;
            font-family: 'Inter', sans-serif;
            border-radius: 1.5rem;
        }

        #giftBoxScreen h2, #letterScreen h2 {
            color: #FFD700;
        }

        #letterScreen .letter-content {
            background-color: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 250px;
            overflow-y: auto;
            text-align: left;
            line-height: 1.6;
            font-size: 1rem;
            width: 80%;
            max-width: 300px;
        }
        #letterScreen p {
            margin-bottom: 10px;
        }


        /* Điều chỉnh cho di động */
        @media (max-width: 768px) {
            .game-container {
                width: 95vw;
                height: 95vh;
                padding: 10px;
            }
            .initial-screen h1, .game-over-screen h2 {
                font-size: 2rem;
            }
            .initial-screen p, .game-over-screen p {
                font-size: 1rem;
            }
            .gender-selection button {
                padding: 8px 15px;
                font-size: 1rem;
            }
            .start-button, .restart-button, .submit-button, .quiz-button {
                font-size: 1.2rem;
                padding: 10px 20px;
            }
            .keypad button {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            .keypad {
                width: 240px;
            }
            #lockScreen h1 {
                font-size: 2rem;
            }
            #lockScreen .dot {
                width: 12px;
                height: 12px;
            }
            #quizScreen .question {
                font-size: 1rem;
            }
            #quizScreen .options button {
                font-size: 0.9rem;
                padding: 8px 10px;
            }
            #essayScreen textarea {
                height: 80px;
            }
            #readyToPlayScreen h2 {
                font-size: 2rem;
            }
            #readyToPlayScreen p {
                font-size: 1rem;
            }
            #readyToPlayScreen .confirmation-details {
                font-size: 0.9rem;
            }
            .message-box {
                font-size: 0.9rem;
                padding: 20px 25px;
            }
            .message-box button {
                padding: 8px 20px;
                font-size: 0.9rem;
            }
            #letterScreen .letter-content {
                font-size: 0.9rem;
                padding: 15px;
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- Màn hình khóa -->
        <div class="initial-screen" id="lockScreen">
            <h1>Màn hình khóa</h1>
            <p>Nhập mật khẩu:</p>
            <div id="passcodeDots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <div class="keypad">
                <button data-key="1">1</button>
                <button data-key="2">2</button>
                <button data-key="3">3</button>
                <button data-key="4">4</button>
                <button data-key="5">5</button>
                <button data-key="6">6</button>
                <button data-key="7">7</button>
                <button data-key="8">8</button>
                <button data-key="9">9</button>
                <button class="empty-cell"></button>
                <button data-key="0">0</button>
                <button data-key="clear">X</button>
            </div>
            <p id="lockMessage"></p>
        </div>


        <!-- Màn hình Quiz -->
        <div class="initial-screen hidden" id="quizScreen">
            <h2>Câu hỏi về Duy Khoa</h2>
            <p class="question" id="quizQuestion"></p>
            <div class="options" id="quizOptions">
                <!-- Các nút trả lời sẽ được thêm bằng JS -->
            </div>
            <p id="quizResult"></p>
            <button class="quiz-button hidden" id="nextQuestionButton">Tiếp theo</button>
        </div>

        <!-- Màn hình viết đoạn văn -->
        <div class="initial-screen hidden" id="essayScreen">
            <h2>Thử thách 2: Cảm nghĩ về Duy Khoa</h2>
            <p>Hãy viết một đoạn văn ngắn (khoảng 50 chữ) về cảm nghĩ của bạn về Duy Khoa (nội dung của bạn sẽ được chuyển về hệ thống quản lí hộp thư của Duy Khoa mong bạn cứ thật lòng):</p>
            <textarea id="essayInput" rows="5" placeholder="Viết cảm nghĩ của bạn tại đây..."></textarea>
            <p id="wordCount">Số chữ: 0</p>
            <p id="essayMessage"></p>
            <button class="submit-button" id="submitEssayButton" disabled>Gửi</button> <!-- Ban đầu vô hiệu hóa -->
        </div>

        <!-- Màn hình Sẵn sàng chơi! -->
        <div class="initial-screen hidden" id="readyToPlayScreen">
            <h2>Sắn sàng chưa?</h2>
            <p class="confirmation-details">Lưu ý: Game khó nhưng đạt ít nhất 10 là có quà</p>
            <button class="start-button" id="proceedToCharacterSetupButton">Tiếp tục</button>
        </div>

        <!-- Màn hình Đặt tên & Chọn nhân vật -->
        <div class="initial-screen hidden" id="characterSelectionScreen">
            <h1>Flappy Diver Reverse</h1>
            <div class="input-group">
                <label for="playerNameInput">Tên nhân vật của bạn:</label>
                <input type="text" id="playerNameInput" maxlength="10" placeholder="Nhập tên...">
            </div>
            <div class="input-group">
                <label>Chọn nhân vật:</label>
                <div class="gender-selection">
                    <button id="maleButton" data-gender="male">Nam</button>
                    <button id="femaleButton" data-gender="female">Gái</button>
                </div>
            </div>
            <p>Nhấn phím SPACE hoặc nhấp chuột để bơi lên.</p>
            <p>Vuốt lên trên điện thoại để bơi.</p>
            <button class="start-button" id="startGameButton" disabled>BẮT ĐẦU CHƠI</button>
        </div>
        
        <!-- Màn hình game over -->
        <div class="initial-screen hidden" id="gameOverScreen">
            <h2>Trò chơi kết thúc!</h2>
            <p>Điểm của bạn: <span id="finalScore">0</span></p>
            <p>Điểm cao nhất: <span id="finalHighScore">0</span></p>
            <button class="restart-button" id="restartButton">Chơi lại</button>
        </div>

        <!-- Màn hình Hộp Quà -->
        <div class="initial-screen hidden" id="giftBoxScreen">
            <h2>Chúc mừng!</h2>
            <p>Bạn đã đạt được điểm số tuyệt vời là <span id="giftScore">0</span> điểm!</p>
            <p>Duy Khoa có một món quà bất ngờ dành cho bạn.</p>
            <button class="start-button" id="openLetterButton">Mở Thư</button>
        </div>

        <!-- Màn hình Thư Chúc Mừng -->
        <div class="initial-screen hidden" id="letterScreen">
            <h2>Lá Thư Từ Duy Khoa</h2>
            <div class="letter-content">
                <p>Gửi người chơi thân mến,</p>
                <p>Duy Khoa xin chân thành chúc mừng bạn đã đạt được thành tích xuất sắc trong trò chơi này! Điểm số <span id="letterScore">0</span> của bạn đã chứng tỏ sự kiên trì và kỹ năng tuyệt vời.</p>
                <p>Hy vọng bạn đã có những giây phút thư giãn và vui vẻ. Tiếp tục khám phá những điều thú vị khác nhé!</p>
                <p>Trân trọng,</p>
                <p>Nguyễn Duy Khoa</p>
            </div>
            <button class="start-button" id="playAgainFromLetterButton">Chơi Lại</button>
        </div>

        <!-- Hiệu ứng chuyển cảnh kiểu cửa -->
        <div class="door-transition" id="doorTransition">
            <div class="door-left"></div>
            <div class="door-right"></div>
            <div class="center-light"></div>
        </div>

        <!-- Custom Message Box -->
        <div id="messageBox" class="message-box hidden">
            <p id="messageText"></p>
            <button id="messageCloseButton">Đóng</button>
        </div>
    </div>

    <script>
        // Lấy các phần tử DOM
        const gameCanvas = document.getElementById('gameCanvas');
        const ctx = gameCanvas.getContext('2d');

        // Custom Message Box elements
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageCloseButton = document.getElementById('messageCloseButton');

        // Function to show custom message box instead of alert
        function showMessageBox(message, onConfirmCallback = null) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            // Store the callback or attach directly for one-time use
            messageCloseButton.onclick = () => {
                messageBox.classList.add('hidden');
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
                // Reset to default close behavior if needed
                messageCloseButton.onclick = () => { messageBox.classList.add('hidden'); };
            };
        }

        // Màn hình khóa
        const lockScreen = document.getElementById('lockScreen');
        const passcodeDots = document.getElementById('passcodeDots').children;
        const keypadButtons = document.querySelectorAll('.keypad button');
        const lockMessage = document.getElementById('lockMessage');
        let currentPasscode = "";
        const CORRECT_PASSCODE = "1612";
        const MAX_FAILED_ATTEMPTS = 3;
        const LOCKOUT_DURATION = 24 * 60 * 60 * 1000; // 24 giờ tính bằng milliseconds

        // Màn hình Quiz
        const quizScreen = document.getElementById('quizScreen');
        const quizQuestion = document.getElementById('quizQuestion');
        const quizOptions = document.getElementById('quizOptions');
        const quizResult = document.getElementById('quizResult');
        const nextQuestionButton = document.getElementById('nextQuestionButton');
        let currentQuizIndex = 0;
        let correctAnswersCount = 0;
        const quizQuestions = [
            {
                question: "Duy Khoa thích màu nào nhất?",
                options: ["Xanh dương", "Đỏ", "Vàng", "Xanh lá"],
                answer: "Xanh dương"
            },
            {
                question: "Món ăn yêu thích của Duy Khoa là gì?",
                options: ["Phở", "Bánh mì", "Cơm tấm", "Cơm sườn"],
                answer: "Cơm tấm"
            },
            {
                question: "Sở thích cuối tuần của Duy Khoa là gì?",
                options: ["Chơi game", "Đọc sách", "Đi du lịch", "Ngủ"],
                answer: "Đi du lịch"
            },
            {
                question: "Con vật yêu thích của Duy Khoa?",
                options: ["Chó", "Mèo", "Cá", "Chim"],
                answer: "Cá"
            },
            {
                question: "Duy Khoa sinh vào mùa nào?",
                options: ["Xuân", "Hạ", "Thu", "Đông"],
                answer: "Đông"
            }
        ];

        // Màn hình viết đoạn văn
        const essayScreen = document.getElementById('essayScreen');
        const essayInput = document.getElementById('essayInput');
        const wordCountDisplay = document.getElementById('wordCount');
        const essayMessage = document.getElementById('essayMessage');
        const submitEssayButton = document.getElementById('submitEssayButton');
        const MIN_WORD_COUNT = 50; 
        const MAX_WORD_COUNT = 9999; // Không giới hạn trên để cho phép viết nhiều hơn 50 từ

        // Màn hình Sẵn sàng chơi!
        const readyToPlayScreen = document.getElementById('readyToPlayScreen');
        const proceedToCharacterSetupButton = document.getElementById('proceedToCharacterSetupButton'); 

        // Màn hình Đặt tên & Chọn nhân vật (trước đây là startScreen)
        const characterSelectionScreen = document.getElementById('characterSelectionScreen');
        const startGameButton = document.getElementById('startGameButton'); 
        const playerNameInput = document.getElementById('playerNameInput');
        const maleButton = document.getElementById('maleButton');
        const femaleButton = document.getElementById('femaleButton');
        let isNameEntered = false;
        let isGenderSelected = false;
        
        // Màn hình game over
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreDisplay = document.getElementById('finalScore');
        const finalHighScoreDisplay = document.getElementById('finalHighScore');
        const restartButton = document.getElementById('restartButton');

        // New elements for Gift Box and Letter
        const giftBoxScreen = document.getElementById('giftBoxScreen');
        const giftScoreDisplay = document.getElementById('giftScore');
        const openLetterButton = document.getElementById('openLetterButton');
        const letterScreen = document.getElementById('letterScreen');
        const letterScoreDisplay = document.getElementById('letterScore');
        const playAgainFromLetterButton = document.getElementById('playAgainFromLetterButton');

        // Hiệu ứng chuyển cảnh
        const doorTransition = document.getElementById('doorTransition');
        const doorLeft = document.querySelector('.door-left');
        const doorRight = document.querySelector('.door-right');
        const centerLight = document.querySelector('.center-light');

        // Các biến game
        let gameStarted = false; // Flag for overall game session started (after challenges)
        let gameActive = false; // Flag for active game mechanics (gravity, obstacles)
        let gameOver = false;
        let score = 0;
        let highScore = localStorage.getItem('flappyDiverHighScore') || 0;
        let playerName = "Người chơi";
        let playerGender = "male";

        // Cài đặt game
        const CANVAS_WIDTH = 320;
        const CANVAS_HEIGHT = 480;
        const PLAYER_WIDTH = 25;
        const PLAYER_HEIGHT = 35;
        const OBSTACLE_WIDTH = 60;
        const OBSTACLE_GAP = 130;
        const OBSTACLE_SPEED = 1.8; // Tốc độ di chuyển của chướng ngại vật (đã điều chỉnh)
        const GRAVITY = 0.45; // Trọng lực (đã điều chỉnh)
        const JUMP_VELOCITY = -8;

        let playerX, playerY;
        let playerVelocityY;
        let obstacles = [];
        let obstacleSpawnInterval = 1500;
        let lastObstacleTime = 0;
        let animationFrameId;

        // === Hàm chuyển cảnh ===
        function performDoorTransition(callback) {
            doorTransition.classList.remove('hidden');
            doorTransition.classList.remove('open');
            centerLight.style.width = '0px';
            centerLight.style.height = '0px';
            centerLight.style.opacity = '0';
            doorTransition.classList.add('active'); // Kích hoạt overlay để chặn tương tác

            // Đảm bảo transition đã reset trước khi mở cửa
            setTimeout(() => {
                doorTransition.classList.add('open');
                // Gọi callback sau khi cửa mở hoàn toàn và hiệu ứng sáng hoàn tất
                setTimeout(() => {
                    if (callback) {
                        callback();
                    }
                    setTimeout(() => {
                        doorTransition.classList.remove('active'); // Tắt overlay
                        doorTransition.classList.add('hidden'); // Ẩn hoàn toàn overlay
                    }, 500); // Đợi thêm một chút sau khi cửa mở
                }, 1000); // Thời gian mở cửa (tương ứng với transition trong CSS)
            }, 50); // Thời gian chờ nhỏ để CSS reset
        }

        // === Màn hình khóa iOS ===
        function setupLockScreen() {
            lockScreen.classList.remove('hidden');
            quizScreen.classList.add('hidden');
            essayScreen.classList.add('hidden');
            readyToPlayScreen.classList.add('hidden');
            characterSelectionScreen.classList.add('hidden'); 
            gameOverScreen.classList.add('hidden');
            giftBoxScreen.classList.add('hidden'); // Ensure hidden
            letterScreen.classList.add('hidden'); // Ensure hidden
            gameCanvas.style.display = 'none';

            currentPasscode = "";
            updatePasscodeDots();
            lockMessage.textContent = "";

            const failedAttempts = parseInt(localStorage.getItem('failedPasscodeAttempts') || '0');
            const lastFailedTime = parseInt(localStorage.getItem('lastFailedPasscodeTime') || '0');
            const currentTime = Date.now();

            if (failedAttempts >= MAX_FAILED_ATTEMPTS && (currentTime - lastFailedTime < LOCKOUT_DURATION)) {
                const remainingTime = LOCKOUT_DURATION - (currentTime - lastFailedTime);
                const hours = Math.ceil(remainingTime / (1000 * 60 * 60));
                lockMessage.textContent = `Bạn đã nhập sai quá 3 lần. Vui lòng thử lại sau ${hours} giờ.`;
                keypadButtons.forEach(button => button.disabled = true);
                return;
            } else {
                localStorage.setItem('failedPasscodeAttempts', '0');
                localStorage.removeItem('lastFailedPasscodeTime');
                keypadButtons.forEach(button => button.disabled = false);
            }

            keypadButtons.forEach(button => {
                button.onclick = () => {
                    const key = button.dataset.key;
                    if (key === "clear") {
                        currentPasscode = "";
                        lockMessage.textContent = "";
                    } else if (key) {
                        if (currentPasscode.length < 4) {
                            currentPasscode += key;
                        }
                    }
                    updatePasscodeDots();
                    if (currentPasscode.length === 4) {
                        if (currentPasscode === CORRECT_PASSCODE) {
                            localStorage.setItem('failedPasscodeAttempts', '0');
                            localStorage.removeItem('lastFailedPasscodeTime');
                            lockScreen.classList.add('hidden'); // Ẩn màn hình khóa ngay lập tức
                            showMessageBox("Buộc vượt qua 2 bài kiểm tra bất ngờ để có thể được phép chơi game :>", () => {
                                performDoorTransition(() => { // Sau khi đóng message, chuyển cảnh
                                    setupQuizScreen(); 
                                });
                            });
                        } else {
                            let currentAttempts = parseInt(localStorage.getItem('failedPasscodeAttempts') || '0');
                            currentAttempts++;
                            localStorage.setItem('failedPasscodeAttempts', currentAttempts.toString());
                            localStorage.setItem('lastFailedPasscodeTime', Date.now().toString());

                            if (currentAttempts >= MAX_FAILED_ATTEMPTS) {
                                lockMessage.textContent = `Bạn đã nhập sai mật khẩu ${MAX_FAILED_ATTEMPTS} lần. Vui lòng thử lại sau 24 giờ.`;
                                keypadButtons.forEach(button => button.disabled = true);
                            } else {
                                lockMessage.textContent = `Mật khẩu sai! Còn ${MAX_FAILED_ATTEMPTS - currentAttempts} lần thử.`;
                            }
                            setTimeout(() => {
                                currentPasscode = "";
                                updatePasscodeDots();
                            }, 500);
                        }
                    }
                };
            });
        }

        function updatePasscodeDots() {
            for (let i = 0; i < 4; i++) {
                if (i < currentPasscode.length) {
                    passcodeDots[i].classList.add('filled');
                } else {
                    passcodeDots[i].classList.remove('filled');
                }
            }
        }

        // === Màn hình Quiz ===
        function setupQuizScreen() {
            quizScreen.classList.remove('hidden');
            currentQuizIndex = 0;
            correctAnswersCount = 0;
            nextQuestionButton.classList.add('hidden');
            loadQuizQuestion();
            gameCanvas.style.display = 'none'; 
            characterSelectionScreen.classList.add('hidden'); 
            giftBoxScreen.classList.add('hidden'); 
            letterScreen.classList.add('hidden'); 
        }

        function loadQuizQuestion() {
            if (currentQuizIndex >= quizQuestions.length) {
                displayQuizResult();
                return;
            }

            quizResult.textContent = "";
            nextQuestionButton.classList.add('hidden');

            const q = quizQuestions[currentQuizIndex];
            quizQuestion.textContent = `${currentQuizIndex + 1}. ${q.question}`;
            quizOptions.innerHTML = "";

            q.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('quiz-option');
                button.onclick = () => checkQuizAnswer(option, q.answer);
                quizOptions.appendChild(button);
            });
        }

        function checkQuizAnswer(selectedOption, correctAnswer) {
            document.querySelectorAll('.quiz-option').forEach(button => {
                button.disabled = true;
                if (button.textContent === correctAnswer) {
                    button.style.backgroundColor = '#4CAF50';
                } else if (button.textContent === selectedOption) {
                    button.style.backgroundColor = '#EF4444';
                }
            });

            if (selectedOption === correctAnswer) {
                correctAnswersCount++;
                quizResult.textContent = "Chính xác!";
                quizResult.style.color = '#8BC34A';
            } else {
                quizResult.textContent = `Sai! Đáp án đúng là: ${correctAnswer}`;
                quizResult.style.color = '#EF4444';
            }
            nextQuestionButton.classList.remove('hidden');
        }

        nextQuestionButton.onclick = () => {
            currentQuizIndex++;
            loadQuizQuestion();
        };

        function displayQuizResult() {
            let message = "";
            let passQuiz = false;
            if (correctAnswersCount >= 4) {
                message = `Đúng ${correctAnswersCount}/5 câu luôn giỏi thế^^.`;
                quizResult.style.color = '#4CAF50';
                passQuiz = true;
            } else {
                message = `Haizz có ${correctAnswersCount}/5 câu. đúng ít nhất 4 câu để tiếp tục.`;
                quizResult.style.color = '#EF4444';
                passQuiz = false;
            }
            quizQuestion.textContent = "";
            quizOptions.innerHTML = "";
            quizResult.textContent = message;
            nextQuestionButton.classList.add('hidden');

            const continueButton = document.createElement('button');
            continueButton.classList.add('quiz-button');
            if (passQuiz) {
                continueButton.textContent = "Tiếp tục";
                continueButton.onclick = () => {
                    performDoorTransition(() => {
                        quizScreen.classList.add('hidden');
                        setupEssayScreen(); // Chuyển sang màn hình viết đoạn văn
                    });
                };
            } else {
                continueButton.textContent = "Thử lại Quiz";
                continueButton.onclick = () => {
                    setupQuizScreen();
                };
            }
            quizOptions.appendChild(continueButton);
        }

        // === Màn hình viết đoạn văn ===
        function setupEssayScreen() {
            essayScreen.classList.remove('hidden');
            essayInput.value = "";
            wordCountDisplay.textContent = "Số chữ: 0";
            essayMessage.textContent = "";
            submitEssayButton.disabled = true;
            gameCanvas.style.display = 'none'; 
            characterSelectionScreen.classList.add('hidden'); 
            giftBoxScreen.classList.add('hidden'); 
            letterScreen.classList.add('hidden'); 
        }

        essayInput.oninput = () => {
            const text = essayInput.value.trim();
            const words = text.split(/\s+/).filter(word => word.length > 0);
            const wordCount = words.length;
            wordCountDisplay.textContent = `Số chữ: ${wordCount}`;
            essayMessage.textContent = "";

            if (wordCount >= MIN_WORD_COUNT) { 
                submitEssayButton.disabled = false;
                wordCountDisplay.style.color = '#4CAF50';
            } else {
                submitEssayButton.disabled = true;
                wordCountDisplay.style.color = '#EF4444';
            }
        };

        submitEssayButton.onclick = () => {
            const text = essayInput.value.trim();
            const words = text.split(/\s+/).filter(word => word.length > 0);
            const wordCount = words.length;

            if (wordCount >= MIN_WORD_COUNT) {
                performDoorTransition(() => {
                    essayScreen.classList.add('hidden');
                    setupReadyToPlayScreen(); // Chuyển sang màn hình Sẵn sàng chơi!
                });
            } else {
                essayMessage.textContent = `Duy Khoa thân mến, yêu cầu bạn nhập đủ ${MIN_WORD_COUNT} chữ thì mới tiếp tục. Bạn đang có ${wordCount} chữ.`;
                essayMessage.style.color = '#EF4444';
            }
        };

        // === Màn hình Sẵn sàng chơi! ===
        function setupReadyToPlayScreen() {
            readyToPlayScreen.classList.remove('hidden');
            gameCanvas.style.display = 'none'; 
            characterSelectionScreen.classList.add('hidden'); 
            giftBoxScreen.classList.add('hidden'); 
            letterScreen.classList.add('hidden'); 

            proceedToCharacterSetupButton.onclick = () => {
                performDoorTransition(() => {
                    readyToPlayScreen.classList.add('hidden');
                    setupCharacterSelectionScreen(); // Chuyển sang màn hình Đặt tên & Chọn nhân vật
                });
            };
        }

        // === Màn hình Đặt tên & Chọn nhân vật ===
        function setupCharacterSelectionScreen() {
            characterSelectionScreen.classList.remove('hidden');
            lockScreen.classList.add('hidden'); // Ensure hidden
            quizScreen.classList.add('hidden'); // Ensure hidden
            essayScreen.classList.add('hidden'); // Ensure hidden
            readyToPlayScreen.classList.add('hidden'); // Ensure hidden
            gameOverScreen.classList.add('hidden'); // Ensure hidden
            giftBoxScreen.classList.add('hidden'); // Ensure hidden
            letterScreen.classList.add('hidden'); // Ensure hidden

            if (playerName) {
                playerNameInput.value = playerName;
                isNameEntered = true;
            } else {
                playerNameInput.value = "";
                isNameEntered = false;
            }
            
            if (playerGender === 'male') {
                maleButton.classList.add('selected');
                femaleButton.classList.remove('selected');
            } else {
                femaleButton.classList.add('selected');
                maleButton.classList.remove('selected');
            }
            isGenderSelected = true; 

            checkCharacterSelectionInputs();

            playerNameInput.oninput = () => {
                isNameEntered = playerNameInput.value.trim().length > 0;
                checkCharacterSelectionInputs();
            };

            maleButton.onclick = () => {
                playerGender = 'male';
                maleButton.classList.add('selected');
                femaleButton.classList.remove('selected');
                isGenderSelected = true;
                checkCharacterSelectionInputs();
            };

            femaleButton.onclick = () => {
                playerGender = 'female';
                femaleButton.classList.add('selected');
                maleButton.classList.remove('selected');
                isGenderSelected = true;
                checkCharacterSelectionInputs();
            };

            startGameButton.onclick = () => { 
                if (!isNameEntered) {
                    showMessageBox("Vui lòng nhập tên nhân vật của bạn!");
                    return;
                }
                playerName = playerNameInput.value.trim(); 

                if (!isGenderSelected) {
                    showMessageBox("Vui lòng chọn giới tính nhân vật!");
                    return;
                }

                performDoorTransition(() => {
                    characterSelectionScreen.classList.add('hidden');
                    gameCanvas.style.display = 'block'; 
                    resetGameCanvasState(); 
                    gameStarted = true; 
                    gameActive = false; 
                    animationFrameId = requestAnimationFrame(update); 
                });
            };

            gameCanvas.style.display = 'none';
        }

        function checkCharacterSelectionInputs() {
            if (isNameEntered && isGenderSelected) {
                startGameButton.disabled = false;
            } else {
                startGameButton.disabled = true;
            }
        }

        // === Cài đặt Canvas và Game logic ===
        // Điều chỉnh kích thước canvas
        function resizeCanvas() {
            gameCanvas.width = CANVAS_WIDTH;
            gameCanvas.height = CANVAS_HEIGHT;

            const container = document.querySelector('.game-container');
            const containerWidth = container.clientWidth - (20 * 2);
            const containerHeight = container.clientHeight - (20 * 2);

            const aspectRatio = CANVAS_WIDTH / CANVAS_HEIGHT;
            let displayWidth = containerWidth;
            let displayHeight = containerWidth / aspectRatio;

            if (displayHeight > containerHeight) {
                displayHeight = containerHeight;
                displayWidth = containerHeight * aspectRatio;
            }

            gameCanvas.style.width = `${displayWidth}px`;
            gameCanvas.style.height = `${displayHeight}px`;

            container.style.backgroundColor = '#4A90E2';
        }

        window.addEventListener('resize', resizeCanvas);

        function resetGameCanvasState() {
            playerX = CANVAS_WIDTH - 80 - PLAYER_WIDTH; // Vị trí nhân vật bên phải
            playerY = CANVAS_HEIGHT / 2 - PLAYER_HEIGHT / 2; // Vị trí khởi tạo an toàn ở giữa
            playerVelocityY = 0;
            obstacles = [];
            score = 0;
            gameOver = false;
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        }

        // Vẽ phong cảnh dưới nước
        function drawBackground() {
            ctx.fillStyle = '#DED895'; 
            ctx.fillRect(0, CANVAS_HEIGHT - 40, CANVAS_WIDTH, 40);
            ctx.strokeStyle = '#C4BC87'; 
            ctx.lineWidth = 2;
            ctx.strokeRect(0, CANVAS_HEIGHT - 40, CANVAS_WIDTH, 40);

            for (let i = 0; i < 20; i++) {
                const bubbleX = Math.random() * CANVAS_WIDTH;
                const bubbleY = Math.random() * CANVAS_HEIGHT;
                const bubbleRadius = Math.random() * 3 + 1;
                ctx.beginPath();
                ctx.arc(bubbleX, bubbleY, bubbleRadius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.3})`;
                ctx.fill();
            }
        }

        // Vẽ nhân vật người
        function drawPlayer() {
            const skinColor = playerGender === 'male' ? '#DEA17B' : '#E6A7A7';
            const swimsuitColor = playerGender === 'male' ? '#007ACC' : '#FF69B4';
            const hairColor = playerGender === 'male' ? '#4A2A1A' : '#A0522D';

            ctx.save();
            // Lật hình ảnh theo chiều ngang để nhân vật nhìn sang trái (hướng ngược lại dòng chảy)
            ctx.translate(playerX + PLAYER_WIDTH / 2, playerY + PLAYER_HEIGHT / 2);
            ctx.scale(-1, 1); 

            const relativeX = -PLAYER_WIDTH / 2; // Điều chỉnh tọa độ để vẽ từ gốc của khung bị lật
            const relativeY = -PLAYER_HEIGHT / 2;

            const headRadius = PLAYER_HEIGHT * 0.25;
            const bodyWidth = PLAYER_WIDTH * 0.8;
            const bodyHeight = PLAYER_HEIGHT * 0.6;

            // Body
            ctx.fillStyle = skinColor;
            ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2, relativeY + headRadius * 0.8, bodyWidth, bodyHeight);

            // Swimsuit
            ctx.fillStyle = swimsuitColor;
            if (playerGender === 'male') {
                ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2, relativeY + headRadius * 0.8 + bodyHeight * 0.6, bodyWidth, bodyHeight * 0.4);
            } else {
                ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2, relativeY + headRadius * 0.8 + bodyHeight * 0.5, bodyWidth, bodyHeight * 0.5);
                ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2, relativeY + headRadius * 0.8, bodyWidth, bodyHeight * 0.15);
            }

            // Head
            ctx.beginPath();
            ctx.arc(relativeX + PLAYER_WIDTH / 2, relativeY + headRadius, headRadius, 0, Math.PI * 2);
            ctx.fill();

            // Hair
            ctx.fillStyle = hairColor;
            if (playerGender === 'male') {
                ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2 + 2, relativeY + headRadius * 0.2, bodyWidth - 4, headRadius * 0.6);
            } else {
                ctx.beginPath();
                ctx.arc(relativeX + PLAYER_WIDTH / 2, relativeY + headRadius, headRadius * 1.1, 0, Math.PI, false);
                ctx.fill();
            }

            // Legs
            ctx.fillStyle = skinColor;
            ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2 + (bodyWidth * 0.2), relativeY + PLAYER_HEIGHT - 8, 4, 8);
            ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2 + (bodyWidth * 0.8) - 4, relativeY + PLAYER_HEIGHT - 8, 4, 8);

            // Arms
            ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2 - 3, relativeY + headRadius * 0.8 + bodyHeight * 0.2, 5, bodyHeight * 0.5);
            ctx.fillRect(relativeX + (PLAYER_WIDTH - bodyWidth) / 2 + bodyWidth - 2, relativeY + headRadius * 0.8 + bodyHeight * 0.2, 5, bodyHeight * 0.5);

            // Eye (adjusted for flipped context to appear on the left side of the face relative to its current orientation)
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(relativeX + PLAYER_WIDTH / 2 + 4, relativeY + headRadius * 0.8, 2, 0, Math.PI * 2); 
            ctx.fill();

            ctx.restore();
        }

        // Tạo chướng ngại vật (rong biển/san hô)
        function createObstacle() {
            const minHeight = 60;
            const maxHeight = CANVAS_HEIGHT - OBSTACLE_GAP - 60 - 40;
            const topHeight = Math.floor(Math.random() * (maxHeight - minHeight + 1)) + minHeight;
            const bottomHeight = CANVAS_HEIGHT - topHeight - OBSTACLE_GAP - 40;

            obstacles.push({
                x: 0 - OBSTACLE_WIDTH, // Chướng ngại vật xuất hiện từ bên trái (off-screen)
                top: topHeight,
                bottom: bottomHeight,
                passed: false
            });
        }

        // Vẽ chướng ngại vật (rong biển/san hô)
        function drawObstacles() {
            ctx.fillStyle = '#2E8B57';
            ctx.strokeStyle = '#1E5939';
            ctx.lineWidth = 2;

            obstacles.forEach(obstacle => {
                ctx.beginPath();
                ctx.moveTo(obstacle.x, 0);
                ctx.lineTo(obstacle.x + OBSTACLE_WIDTH, 0);
                ctx.lineTo(obstacle.x + OBSTACLE_WIDTH, obstacle.top);
                ctx.lineTo(obstacle.x, obstacle.top);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(obstacle.x, CANVAS_HEIGHT - obstacle.bottom - 40);
                ctx.lineTo(obstacle.x + OBSTACLE_WIDTH, CANVAS_HEIGHT - obstacle.bottom - 40);
                ctx.lineTo(obstacle.x + OBSTACLE_WIDTH, CANVAS_HEIGHT - 40);
                ctx.lineTo(obstacle.x, CANVAS_HEIGHT - 40);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#3CB371';
                if (Math.random() > 0.5) {
                    ctx.beginPath();
                    ctx.arc(obstacle.x + OBSTACLE_WIDTH / 2, obstacle.top - 10, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(obstacle.x + OBSTACLE_WIDTH / 2, CANVAS_HEIGHT - obstacle.bottom - 30, 8, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }

        // Vẽ điểm số lên canvas
        function drawScore() {
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 3;
            ctx.font = 'bold 48px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            const scoreText = score.toString();
            const textX = CANVAS_WIDTH / 2;
            const textY = 50;

            ctx.strokeText(scoreText, textX, textY);
            ctx.fillText(scoreText, textX, textY);
        }

        // Vẽ tên nhân vật lên canvas
        function drawPlayerName() {
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.font = 'bold 16px "Inter"';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            ctx.strokeText(playerName, 10, 10);
            ctx.fillText(playerName, 10, 10);
        }

        // Vẽ hướng dẫn ban đầu trên canvas
        function drawInitialReadyText() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT); // Clear canvas
            drawBackground(); // Draw background and player
            drawPlayer();
            
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.font = 'bold 20px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.strokeText("NHẤN ĐỂ BƠI", CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 - 50);
            ctx.fillText("NHẤN ĐỂ BƠI", CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 - 50);
            ctx.font = 'bold 12px "Inter"';
            ctx.strokeText("Hoặc Vuốt Lên", CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 + 10);
            ctx.fillText("Hoặc Vuốt Lên", CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 + 10);
        }

        // Vòng lặp cập nhật game chính
        function update(currentTime) {
            if (gameOver || !gameStarted) {
                if (gameStarted && !gameActive) {
                    drawInitialReadyText(); // Tiếp tục vẽ thông báo "NHẤN ĐỂ BƠI"
                }
                animationFrameId = requestAnimationFrame(update);
                return;
            }

            if (gameActive) { // Chỉ áp dụng cơ chế game khi game active
                playerVelocityY += GRAVITY;
                playerY += playerVelocityY;

                if (playerY + PLAYER_HEIGHT >= CANVAS_HEIGHT - 40) { // Va chạm với đáy
                    playerY = CANVAS_HEIGHT - PLAYER_HEIGHT - 40;
                    endGame();
                    return;
                }

                if (playerY < 0) { // Va chạm với đỉnh
                    playerY = 0;
                    playerVelocityY = 0;
                }

                if (currentTime - lastObstacleTime > obstacleSpawnInterval) {
                    createObstacle();
                    lastObstacleTime = currentTime;
                }

                obstacles.forEach(obstacle => {
                    obstacle.x += OBSTACLE_SPEED; // Chướng ngại vật di chuyển từ trái sang phải

                    // Kiểm tra va chạm giữa người chơi và chướng ngại vật
                    if (
                        playerX < obstacle.x + OBSTACLE_WIDTH &&
                        playerX + PLAYER_WIDTH > obstacle.x &&
                        (playerY < obstacle.top || playerY + PLAYER_HEIGHT > CANVAS_HEIGHT - obstacle.bottom - 40)
                    ) {
                        endGame();
                        return;
                    }

                    // Tăng điểm khi chướng ngại vật vượt qua người chơi
                    // Khi cạnh phải của chướng ngại vật vượt qua cạnh trái của người chơi
                    if (obstacle.x + OBSTACLE_WIDTH < playerX && !obstacle.passed) { 
                        score++;
                        obstacle.passed = true;
                    }
                });

                // Loại bỏ chướng ngại vật đã ra khỏi màn hình bên phải
                obstacles = obstacles.filter(obstacle => obstacle.x < CANVAS_WIDTH);

                ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                drawBackground();
                drawObstacles();
                drawPlayer();
                drawScore();
                drawPlayerName();
            } 

            animationFrameId = requestAnimationFrame(update);
        }

        // Kết thúc trò chơi
        function endGame() {
            gameOver = true;
            cancelAnimationFrame(animationFrameId);

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('flappyDiverHighScore', highScore);
            }

            finalScoreDisplay.textContent = score;
            finalHighScoreDisplay.textContent = highScore;
            
            if (score >= 10) {
                gameOverScreen.classList.add('hidden'); // Hide normal game over
                setupGiftBoxScreen(); // Show gift box
            } else {
                gameOverScreen.classList.remove('hidden'); // Show normal game over
            }
        }

        // Kích hoạt cú bơi của nhân vật (và bắt đầu game mechanics nếu đây là cú bơi đầu tiên)
        function playerSwimUp() {
            if (gameOver) return; 
            if (!gameStarted) return; 

            if (!gameActive) { 
                gameActive = true; 
                lastObstacleTime = performance.now(); 
            }
            playerVelocityY = JUMP_VELOCITY;
        }

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                playerSwimUp();
            }
        });

        gameCanvas.addEventListener('click', () => {
            playerSwimUp();
        });

        let touchStartY = 0;
        gameCanvas.addEventListener('touchstart', (e) => {
            if (!gameStarted) return;
            touchStartY = e.touches[0].clientY;
        });

        gameCanvas.addEventListener('touchend', (e) => {
            if (!gameStarted) return;
            const touchEndY = e.changedTouches[0].clientY;
            const dy = touchEndY - touchStartY;

            if (dy < -20) { // Vuốt lên
                playerSwimUp();
            }
        });

        // Nút chơi lại
        restartButton.addEventListener('click', () => {
            gameOverScreen.classList.add('hidden');
            // Bắt đầu game ngay lập tức mà không cần qua màn hình chọn nhân vật
            gameCanvas.style.display = 'block'; 
            resetGameCanvasState(); 
            gameStarted = true; 
            gameActive = false; // Vẫn chờ người dùng nhấn để bơi
            animationFrameId = requestAnimationFrame(update);
        });

        // Functions for Gift Box and Letter screens
        function setupGiftBoxScreen() {
            giftBoxScreen.classList.remove('hidden');
            giftScoreDisplay.textContent = score; // Display current score on gift box
            openLetterButton.onclick = () => {
                performDoorTransition(() => {
                    giftBoxScreen.classList.add('hidden');
                    setupLetterScreen();
                });
            };
        }

        function setupLetterScreen() {
            letterScreen.classList.remove('hidden');
            letterScoreDisplay.textContent = score; // Display score in the letter content
            playAgainFromLetterButton.onclick = () => {
                performDoorTransition(() => {
                    letterScreen.classList.add('hidden');
                    // Go back to character selection screen (to reset or re-enter name/gender)
                    setupCharacterSelectionScreen(); 
                });
            };
        }

        // --- Khởi tạo game ban đầu ---
        document.addEventListener('DOMContentLoaded', () => {
            resizeCanvas();
            setupLockScreen(); // Luôn bắt đầu từ màn hình khóa cho một phiên mới
        });
    </script>
</body>
</html>
